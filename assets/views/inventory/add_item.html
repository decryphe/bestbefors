<!doctype html>
<html lang="en">
    {% include "inc_head.html" %} {% include "inc_navbar.html" %}
    <body class="container">
        <h1>{{ form_title | default(value="Add Inventory Item") }}</h1>
        <form method="POST" action="{{ form_action | default(value='/inventory/add') }}">
            <div class="mb-3">
                <label for="itemName" class="form-label"> Item Name </label>
                <input
                    type="text"
                    class="form-control"
                    id="itemName"
                    name="name"
                    value="{% if item %}{{ item.name }}{% endif %}"
                />
            </div>
            <div class="mb-3">
                <label for="itemSerial" class="form-label">
                    Serial Number
                </label>
                <input
                    type="text"
                    class="form-control"
                    id="itemSerial"
                    name="serial_number"
                    value="{% if item and item.serial_number %}{{ item.serial_number }}{% endif %}"
                />
            </div>

            <script>
                const item_kinds = {{ item_kinds | json_encode() | safe }};
                const expiries = {{ expiries | json_encode() | safe }};
                const isEdit = {{ is_edit | default(value=false) | json_encode() | safe }};
                const existingItem = {{ item | json_encode() | safe }};
                function calculateExpiry() {
                    let expiry = expiries.find((e) => e.id == document.getElementById("itemExpirySelect").value);
                    let utcNow = new Date();

                    let newExpiry = new Date();
                    if (expiry.sqlite_modifier === "months") {
                        newExpiry = new Date(utcNow.setMonth(utcNow.getMonth() + expiry.sqlite_num_of_modifier));
                    } else if (expiry.sqlite_modifier === "years") {
                        newExpiry = new Date(utcNow.setFullYear(utcNow.getFullYear() + expiry.sqlite_num_of_modifier));
                    } else if (expiry.sqlite_modifier === "never") {
                      newExpiry = null;
                    }

                    if (expiry.sqlite_modifier === "never") {
                        document.getElementById("itemExpiry").setAttribute("disabled", "true");
                        document.getElementById("itemExpiry").value = null;
                    } else {
                        document.getElementById("itemExpiry").removeAttribute("disabled");
                        document.getElementById("itemExpiry").value = newExpiry.toISOString().substring(0,10);
                    }
                }
                function onChangeItemKind(element) {
                    let item_kind = item_kinds.find((item) => item.id == element.value);
                    document.getElementById("itemChecklist").value = item_kind.default_checklist_id;
                    document.getElementById("itemCheckInterval").value = item_kind.default_interval_id;
                    document.getElementById("itemExpirySelect").value = item_kind.default_expiry_id;
                    calculateExpiry();
                }
                function initForm() {
                    if (!isEdit) {
                        calculateExpiry();
                        return;
                    }
                    const expiryInput = document.getElementById("itemExpiry");
                    if (!expiryInput) {
                        return;
                    }
                    if (existingItem && existingItem.expiry) {
                        const initialDate = new Date(existingItem.expiry);
                        expiryInput.value = initialDate.toISOString().substring(0, 10);
                    } else {
                        expiryInput.value = "";
                    }
                    expiryInput.removeAttribute("disabled");
                }
                window.addEventListener("DOMContentLoaded", initForm);
            </script>
            <div class="mb-3">
                <label for="itemKind" class="form-label"> Item Kind </label>
                <select
                    class="form-select"
                    id="itemKind"
                    name="item_kind_id"
                    onchange="onChangeItemKind(this)"
                >
                    {% for item_kind in item_kinds %}
                    <option
                        value="{{ item_kind.id }}"
                        {% if item and item.inventory_item_kind_id == item_kind.id %}
                        selected
                        {% elif not item and loop.first %}
                        selected
                        {% endif %}
                    >
                        {{ item_kind.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="itemChecklist" class="form-label">
                    Checklist
                </label>
                <select
                    class="form-select"
                    id="itemChecklist"
                    name="checklist_id"
                >
                    {% for checklist in checklists %}
                    <option
                        value="{{ checklist.id }}"
                        {% if item and item.checklist_id == checklist.id %}
                        selected
                        {% elif not item and loop.first %}
                        selected
                        {% endif %}
                    >
                        {{ checklist.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="itemCheckInterval" class="form-label">
                    Check Interval
                </label>
                <select
                    class="form-select"
                    id="itemCheckInterval"
                    name="interval_id"
                >
                    {% for interval in intervals %}
                    <option
                        value="{{ interval.id }}"
                        {% if item and item.interval_id == interval.id %}
                        selected
                        {% elif not item and loop.first %}
                        selected
                        {% endif %}
                    >
                        {{ t(key=interval.code, lang="de-DE") }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="itemExpirySelect" class="form-label">
                    Expiry
                </label>
                <select
                    class="form-select mb-3"
                    id="itemExpirySelect"
                    onchange="calculateExpiry()"
                >
                    {% for expiry in expiries %}
                    <option
                        value="{{ expiry.id }}"
                        {% if not item and loop.first %}
                        selected
                        {% endif %}
                    >
                        {{ t(key=expiry.code, lang="de-DE") }}
                    </option>
                    {% endfor %}
                </select>
                <input
                    class="form-control"
                    type="date"
                    id="itemExpiry"
                    name="expiry"
                    value=""
                    min="2020-01-01"
                    max="2100-01-01"
                    disabled
                />
            </div>

            <button type="submit" class="btn btn-primary">
                {{ submit_label | default(value="Submit") }}
            </button>
        </form>
        <div class="row">
            <div class="col"></div>
        </div>
    </body>
</html>
